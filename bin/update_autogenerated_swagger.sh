#!/bin/sh

CURRENT_FOLDER=`pwd`

if [[ "$CURRENT_FOLDER" == */bin ]]; then
    echo "Run this script from the root of the repository"
    exit 1
fi

CURL_EXISTS=`which curl`
DOCKER_EXISTS=`which docker`
DOCKER_COMPOSE_EXISTS=`which docker-compose`
BOUNTIES_API_IMAGE_EXISTS=`docker images | grep bounties_api`
SLEEP_FOR_SECONDS=20
EXPORT_PATH=$1
if [ "$EXPORT_PATH" != "" ]; then
    EXPORT_PATH="bounties_api/static/autogenerated_swagger.yml"
fi

if [ "$CURL_EXISTS" != "" ] && [ "$DOCKER_EXISTS" != "" ] && [ "$DOCKER_COMPOSE_EXISTS" != "" ] && [ "$BOUNTIES_API_IMAGE_EXISTS" != "" ]; then
    echo "Taking down old containers"
    echo
    docker-compose down --remove-orphans
    echo
    echo "Starting up bounties_api"
    echo
    docker-compose up --detach bounties_api
    echo
    echo "Waiting $SLEEP_FOR_SECONDS seconds for container to get up and running..."
    echo
    sleep $SLEEP_FOR_SECONDS
    echo
    echo "Exporting swagger to $EXPORT_PATH"
    echo
    curl http://localhost:8000/swagger.yaml > $EXPORT_PATH
    echo
    echo "Shutting down..."
    echo
    docker-compose down --remove-orphans
    echo
    echo "Done! Check git status to see what the potential changes were"
else
    echo "Can't update autogenerated swagger, check these dependencies:" 
    echo "CURL_EXISTS is: $CURL_EXISTS"
    echo "DOCKER_EXISTS is: $DOCKER_EXISTS"
    echo "DOCKER_COMPOSE_EXISTS is: $DOCKER_COMPOSE_EXISTS"
    echo "BOUNTIES_API_IMAGE_EXISTS is: $BOUNTIES_API_IMAGE_EXISTS"
fi
